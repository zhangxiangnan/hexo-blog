layout: title
title: 微服务总体认识
date: 2019-03-30 23:27:01
tags:
- 微服务
categories:
- 微服务
---

### 为什么选用微服务？
微服务相对单体应用而言，单体应用即单个服务包含所用功能，统一维护部署；微服务是单体应用拆分的多个小些的服务。

#### 单体应用的缺点
- 包含所有功能，改一处功能或者一处功能有问题影响整个服务稳定性
- 随着业务迭代，项目易变得庞大混乱，团队代码合并成本高，定位故障也复杂
- 单体应用使用统一框架、语言，可能有些模块使用其他语言更适合，无法个性化
- 编译、部署时间长，成本高
单体与微服务要根据具体业务体量及团队大小，不能盲目追随微服务。

#### 微服务的缺点
- 一个人可能需要维护很多小型服务（维护成本高）
- 单个服务独立部署会浪费些硬件资源
- 可能引入跨服务事务即分布式事务、跨库查询的问题（耦合的数据库逻辑最好不要拆到多个服务）
- 性能下降
- 可用性问题
- 测试、排查问题成本高
- 系统架构变复杂
  
### 什么是服务化？
单体应用各个maven模块之间通过jar依赖调用自身服务的本地方法，是单个进程内的调用逻辑；或者直接调用自身服务的某个service类，服务化即单体应用按业务或其他原则拆分多个小服务后，小服务间通过rpc（http、thrift等）调用，是多个进程间，多个主机间的调用逻辑

微服务是更细粒度的服务化

- 拆分粒度更细，某个模块也可以单独拆
- 单独部署维护

### 如何拆分
- 纵向，按业务领域、业务功能模块拆分，如拆为首页服务、价格、预定、生单等
- 横向，将公共公用、独立的功能拆分出来，提供服务给多个服务使用，如用户服务可以作为公共基础服务给多个使用方提供用户信息的查询
- 一个业务进行读写拆分，提升稳定性
- 按qps高低拆分

拆分太细，维护成本太高，性能也会变差，要把我合适的粒度，综合分析有必要拆再拆

### 何时拆分
团队规模逐步扩大，业务逐渐复杂，多人协作维护一个单体应用时沟通、编译、发布、维护等成本变高时，或者为了某个功能的稳定性，当掌握微服务相关技术栈后可以考虑拆分

### 服务化引入的问题
- 服务间通信采用何种协议，http、rpc以及接口的格式、规范、版本、兼容性等问题
- 服务如何注册发现？注册中心
- 服务监控包括性能，调用链路成功率，稳定性
- 服务间的调用治理，包括超时、重试、熔断降级、截流等，以及服务的上下链路调用与被调用服务的管理（哪些服务，哪些机器提供、机房分布等）
- 问题排查需要各个服务间有一个追踪标识，请求id等唯一标识请求

### 微服务的基本组件
- 服务描述（接口文档、api）
  
  服务提供的接口名称，参数格式（参数名、类型），返回结果格式（值及类型），常见服务描述方式：
  - RESTFul API，描述http、https协议的服务描述，swagger管理
  - xml配置，rpc协议的服务描述
  - idl，thrift、grpc跨语言服务调用框架

- 注册中心
  
  可以自己实现，或者使用开源框架，如zookeeper、nacos、consul、eureka等
  - 1、服务提供者将提供的服务、服务ip地址、端口号登记到注册中心；
  - 2、服务消费者根据其配置文件中描述的服务信息从注册中心订阅所需服务
  - 3、注册中心返回服务提供者地址列表给服务消费者，服务消费者根据得到的服务提供者的ip、端口等信息，通过轮询、一致性hash等负载均衡策略，直接发起调用（不经过注册中心）
  - 4、服务提供者下线、上线机器/节点时，注册中心将变更通知给服务消费者（如zookeeper的临时有序节点实现节点下线通知），服务消费者剔除/增加节点信息。 

- 服务框架
  
  注册中心使服务消费者得到服务提供者的地址，要有以下信息才可以调用：
  - 服务通信协议 四层的tcp、udp、七层http...
  - 数据传输方式 同步、异步，连接是单连接、多路复用
  - 数据压缩格式 压缩减少网络传输时间及带宽，json、protbuf、xml、hession、kyro、java序列化、thrift等

- 服务监控
  
  对服务消费者与服务提供者之间的调用次数、成功率等指标收集、统计、展示
    - 指标收集 每次请求耗时、成功与否、源ip、目的ip、接口名称等
    - 聚合处理 每秒qps，平均耗时、tp95、tp90、tp99、tp99.9、成功率等
    - 监控展示 界面化展示查看，可添加监控报警，按不同时间（小时、天、周等）、维度（主机、接口名等）聚合统计

- 服务追踪
  
  分布式服务追踪，用于排查问题，一个traceid或requestid查询所有服务的日志，分析原因

- 服务治理
  
  - 单节点故障自动摘除
  - 机房故障自动切换其他机房，中心故障自动切换其他中心，本地不可用切异地
  - 熔断截流机制
  - 超时重试
  - 同机房、同中心、同地域优先调用
  - 服务手动禁用、下线
  - 自动弹性扩容
